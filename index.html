<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Ajedrez Siurot - Sistema Suizo</title>
    
    <link rel="icon" href="https://raw.githubusercontent.com/ManuelVS8/Torneo_Ajedrez_Siurot_SUIZO/refs/heads/main/suizo.ico" type="image/x-icon">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#07c8dc">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        :root {
            /* Paleta Original con el nuevo Cian solicitado */
            --primary: #07c8dc;        
            --secondary: #f8fafc;      
            --accent: #07c8dc;         
            --accent-light: #e0faff; 
            --success: #22c55e;        
            --win-color: #dcfce7; 
            --loss-color: #fee2e2; 
            --draw-color: #f1f5f9; 
            --round-done: #e2e8f0; 
            --round-done-text: #64748b; 
            --danger: #ef4444; 
            --text: #1e293b; 
            --light-text: #64748b; 
            --border: #e2e8f0; 
            --card-bg: #ffffff; 
        }

        * { 
            box-sizing: border-box; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            -webkit-font-smoothing: antialiased;
        }

        body { 
            margin: 0; 
            padding: 0; 
            background-color: #f1f5f9; 
            color: var(--text); 
            padding-bottom: 90px; 
            -webkit-tap-highlight-color: transparent; 
            overflow-x: hidden;
        }

        /* Cabecera */
        header { 
            background-color: var(--primary); 
            color: white; 
            padding: 1.2rem 1rem; 
            text-align: center; 
            position: sticky; 
            top: 0; 
            z-index: 100; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.15); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }

        .header-text { text-align: left; flex: 1; }
        h1 { margin: 0; font-size: 1.4rem; letter-spacing: 0.5px; }
        .subtitle { font-size: 0.85rem; opacity: 0.9; margin-top: 2px; font-weight: 400; }

        #adminBtn { 
            background: rgba(255,255,255,0.2); 
            border: 1px solid rgba(255,255,255,0.3); 
            color: white; 
            border-radius: 50%; 
            width: 44px; 
            height: 44px; 
            font-size: 1.3rem; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            margin-left: 10px; 
            flex-shrink: 0; 
        }

        #adminBtn.unlocked { 
            background-color: var(--success); 
            border-color: var(--success); 
            box-shadow: 0 0 15px rgba(34, 197, 94, 0.6); 
            transform: rotate(360deg);
        }

        /* Contenedor Principal */
        .container { padding: 1rem; max-width: 650px; margin: 0 auto; }

        .tab-content { display: none; animation: fadeIn 0.4s ease-out; }
        .tab-content.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity:1; transform: translateY(0); } }

        .card { 
            background: var(--card-bg); 
            border-radius: 16px; 
            padding: 1.5rem; 
            margin-bottom: 1.2rem; 
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); 
            position: relative; 
            border: 1px solid var(--border); 
        }

        /* Sistema de Bloqueo Admin */
        body.is-locked .editable-element { 
            opacity: 0.4; 
            pointer-events: none; 
            user-select: none; 
            filter: grayscale(100%);
        }

        .lock-overlay { 
            display: none; 
            text-align: center; 
            color: #ef4444; 
            padding: 12px; 
            font-weight: 700; 
            font-size: 0.9rem; 
            background: #fff1f2; 
            border-radius: 10px; 
            margin-bottom: 15px; 
            border: 1px dashed #fecaca; 
        }

        body.is-locked .show-lock-msg .lock-overlay { display: block; }

        /* Formulario y Botones */
        textarea { 
            width: 100%; 
            height: 180px; 
            padding: 14px; 
            border: 2px solid var(--border); 
            border-radius: 10px; 
            resize: vertical; 
            font-size: 16px; 
            background: #f8fafc; 
            color: var(--text); 
            outline: none;
            transition: border-color 0.2s;
        }

        textarea:focus { border-color: var(--primary); }

        button { 
            background-color: var(--accent); 
            color: white; 
            border: none; 
            padding: 14px 24px; 
            border-radius: 10px; 
            font-size: 1rem; 
            cursor: pointer; 
            width: 100%; 
            margin-top: 12px; 
            font-weight: 700; 
            transition: all 0.2s ease; 
            box-shadow: 0 4px 6px rgba(7, 200, 220, 0.2);
        }

        button:hover { opacity: 0.95; transform: translateY(-1px); }
        button:active { transform: scale(0.97); }
        button.export { background-color: #0f172a; box-shadow: 0 4px 6px rgba(15, 23, 42, 0.2); }
        button.danger { background-color: var(--danger); box-shadow: 0 4px 6px rgba(239, 68, 68, 0.2); }
        button.warning { background-color: #f59e0b; box-shadow: 0 4px 6px rgba(245, 158, 11, 0.2); }
        button:disabled { background-color: #cbd5e1; cursor: not-allowed; box-shadow: none; color: #94a3b8; }

        /* Tarjetas de Partida */
        .match-card { 
            display: flex; 
            flex-direction: column; 
            background: white; 
            border-radius: 12px; 
            padding: 15px; 
            margin-bottom: 15px; 
            border: 1px solid var(--border); 
            border-left: 5px solid var(--primary); 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .match-header { 
            font-size: 0.8rem; 
            color: var(--light-text); 
            margin-bottom: 10px; 
            text-transform: uppercase; 
            font-weight: 800; 
            letter-spacing: 1px; 
        }

        .players { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .player-name { font-weight: 700; flex: 1; font-size: 1.1rem; transition: all 0.3s; border-radius: 4px; padding: 2px 6px; display: inline-block; }
        
        /* Colores de Resultado Aplicados */
        .player-name.winner { background: var(--win-color); color: #15803d; }
        .player-name.loser { background: var(--loss-color); color: #b91c1c; }
        .player-name.draw { background: var(--draw-color); color: #475569; }

        /* Info extra (Puntos/Color) */
        .player-info { font-size: 0.7rem; color: var(--light-text); font-weight: 500; margin-left: 6px; opacity: 0.9; }
        
        .vs { font-size: 0.85rem; color: var(--light-text); padding: 0 12px; font-weight: 400; font-style: italic; }

        .result-select { 
            width: 100%; 
            padding: 12px; 
            border-radius: 8px; 
            border: 2px solid var(--border); 
            background: #f8fafc; 
            font-size: 1rem; 
            color: var(--text); 
            outline: none; 
            -webkit-appearance: none;
            cursor: pointer;
        }

        /* Tabla de Ranking */
        table { width: 100%; border-collapse: separate; border-spacing: 0; background: white; border-radius: 12px; overflow: hidden; border: 1px solid var(--border); }
        th, td { padding: 14px; text-align: left; border-bottom: 1px solid var(--border); }
        th { background-color: #f8fafc; color: var(--light-text); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1.5px; font-weight: 800; }
        .points-col { text-align: right; font-weight: 800; color: var(--primary); font-size: 1.1rem; }
        .rank-col { width: 50px; text-align: center; color: var(--light-text); font-weight: 900; background: #f1f5f9; border-right: 1px solid var(--border); }
        tr:last-child td { border-bottom: none; }
        tr:nth-child(even) { background-color: #fbfcfe; }

        /* Modales */
        .modal { display: none; position: fixed; z-index: 200; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); justify-content: center; align-items: center; padding: 20px; }
        .modal-content { background-color: white; padding: 30px; border-radius: 20px; width: 100%; max-width: 400px; text-align: center; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); animation: modalIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        @keyframes modalIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .modal-buttons { display: flex; gap: 12px; margin-top: 25px; }
        #pwdModal input { width: 100%; padding: 14px; margin: 15px 0; border: 2px solid var(--border); border-radius: 10px; font-size: 18px; text-align: center; letter-spacing: 4px; }

        /* Cargando y Toast */
        #loadingOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 300; justify-content: center; align-items: center; flex-direction: column; }
        .spinner { border: 5px solid #f3f3f3; border-top: 5px solid var(--primary); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Navegaci√≥n Inferior */
        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: white; display: flex; justify-content: space-around; padding: 12px 0 25px 0; box-shadow: 0 -4px 15px rgba(0,0,0,0.08); z-index: 99; border-top: 1px solid var(--border); }
        .nav-item { text-align: center; color: var(--light-text); font-size: 0.8rem; cursor: pointer; flex: 1; transition: all 0.2s; }
        .nav-item.active { color: var(--primary); font-weight: 800; transform: translateY(-3px); }
        .nav-icon { font-size: 1.5rem; display: block; margin-bottom: 4px; }

        /* Selector de Rondas */
        .round-selector { display: flex; overflow-x: auto; gap: 10px; padding: 5px 2px 15px 2px; margin-bottom: 10px; scrollbar-width: none; }
        .round-selector::-webkit-scrollbar { display: none; }
        .round-chip { background: #e2e8f0; color: #64748b; padding: 10px 22px; border-radius: 25px; white-space: nowrap; font-size: 0.9rem; cursor: pointer; transition: all 0.2s; border: 1px solid transparent; font-weight: 600; }
        .round-chip.active { background: var(--primary); color: white; font-weight: 800; box-shadow: 0 4px 8px rgba(7, 200, 220, 0.4); border-color: rgba(255,255,255,0.2); }

        #toast { visibility: hidden; min-width: 280px; background-color: #1e293b; color: #fff; text-align: center; border-radius: 12px; padding: 16px; position: fixed; z-index: 1000; left: 50%; bottom: 100px; transform: translateX(-50%); font-size: 0.95rem; box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 70px; opacity: 0;} to {bottom: 100px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 100px; opacity: 1;} to {bottom: 70px; opacity: 0;} }
    </style>
</head>

<body class="is-locked" onclick="playTap()">

<div id="loadingOverlay">
    <div class="spinner"></div>
    <div id="loadingText" style="font-weight: 700; color: var(--primary);">Sincronizando...</div>
</div>

<header>
    <div class="header-text">
        <h1>Ajedrez Siurot</h1>
        <div class="subtitle">Torneo Sistema Suizo ‚Ä¢ FIDE Logic v2.1</div>
    </div>
    <button id="adminBtn" onclick="openPasswordModal(event)" title="Acceso Administrador">üîí</button>
</header>

<div class="container">
    <div id="tab-setup" class="tab-content active">
        <div class="card show-lock-msg">
            <h3>1. Registro de Jugadores</h3>
            <p style="color: var(--light-text); font-size: 0.85rem; line-height: 1.4;">
                Introduce un nombre por l√≠nea. El sistema organizar√° autom√°ticamente las mesas, calcular√° las rondas y asignar√° colores (Blancas/Negras) bajo normas FIDE.
            </p>
            <div class="lock-overlay">üîí MODO LECTURA: Pulsa el candado superior para editar</div>
            <textarea id="playersInput" class="editable-element" placeholder="Ejemplo:&#10;Gari Kasp√°rov&#10;Magnus Carlsen&#10;Judit Polg√°r..."></textarea>
            <button class="editable-element" onclick="playTap(); confirmStartTournament();">üìù Crear e Iniciar Torneo</button>
        </div>

        <div class="card show-lock-msg" id="nextRoundCard" style="display:none;">
            <h3>Gesti√≥n de Emparejamientos</h3>
            <div class="lock-overlay">üîí ACCESO RESTRINGIDO</div>
            <button id="nextRoundBtn" class="editable-element warning" onclick="playTap(); confirmNextRound();">‚è≠Ô∏è Generar Nueva Ronda</button>
            <p style="font-size:0.75rem; color:var(--light-text); margin-top:12px; text-align:center; font-weight:500;">
                Solo genera la ronda cuando todos los resultados actuales est√©n anotados.
            </p>
        </div>

        <div class="card show-lock-msg" id="resetCard" style="display:none;">
            <h3>Zona Cr√≠tica</h3>
            <div class="lock-overlay">üîí √ÅREA PROTEGIDA</div>
            <button class="editable-element danger" onclick="playTap(); confirmResetTournament();">‚ö†Ô∏è Borrar Todo el Torneo</button>
        </div>
    </div>

    <div id="tab-rounds" class="tab-content">
        <div class="round-selector" id="roundSelector"></div>
        <div id="matchesContainer"></div>
        <div class="card show-lock-msg" style="padding: 0; background: transparent; box-shadow: none; border:none; margin-top: 20px;">
             <div class="lock-overlay">üîí Desbloquea para guardar resultados</div>
             <button id="saveBtn" class="editable-element" onclick="playTap(); syncToGoogle()" style="background-color: #1e293b; font-size: 1.1rem; padding: 18px;">üíæ Guardar Cambios en la Nube</button>
        </div>
    </div>

    <div id="tab-ranking" class="tab-content">
        <div class="card" style="padding: 1rem 0.5rem;">
            <h3 style="padding-left: 1rem;">Clasificaci√≥n Provisional</h3>
            <table id="rankingTable">
                <thead>
                    <tr>
                        <th class="rank-col">#</th>
                        <th>Nombre del Jugador</th>
                        <th class="points-col">Pts</th>
                        <th style="text-align:right">BH</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <p style="font-size: 0.7rem; color: var(--light-text); padding: 15px; margin: 0;">
                * Criterio: Puntos totales > Buchholz (Suma de puntos de oponentes).
            </p>
        </div>
    </div>

    <div id="tab-export" class="tab-content">
        <div class="card">
            <h3>Documentos Oficiales</h3>
            <p style="color: var(--light-text); margin-bottom: 20px;">Descarga actas y resultados en formato PDF de alta calidad.</p>
            <button class="export" onclick="playTap(); downloadPDF()">‚¨áÔ∏è Descargar Clasificaci√≥n General</button>
            <button class="export" style="background-color: var(--primary); margin-top: 15px;" onclick="playTap(); downloadMatchesPDF()">üìÖ Descargar Acta de Ronda</button>
        </div>
        <div class="card">
            <h3>Estado del Sistema</h3>
            <div style="display: flex; justify-content: space-between; font-size: 0.9rem;">
                <span>Jugadores:</span> <strong id="statsPlayers">0</strong>
            </div>
            <hr style="border: 0; border-top: 1px solid var(--border); margin: 10px 0;">
            <div style="display: flex; justify-content: space-between; font-size: 0.9rem;">
                <span>Rondas M√°ximas:</span> <strong id="statsRounds">0</strong>
            </div>
        </div>
    </div>
</div>

<div class="bottom-nav">
    <div class="nav-item active" onclick="playTap(); switchTab('tab-setup', this)"><span class="nav-icon">‚öôÔ∏è</span>Config</div>
    <div class="nav-item" onclick="playTap(); switchTab('tab-rounds', this)"><span class="nav-icon">üìÖ</span>Rondas</div>
    <div class="nav-item" onclick="playTap(); switchTab('tab-ranking', this)"><span class="nav-icon">üèÜ</span>Ranking</div>
    <div class="nav-item" onclick="playTap(); switchTab('tab-export', this)"><span class="nav-icon">üìÑ</span>PDF</div>
</div>

<div id="confirmModal" class="modal">
    <div class="modal-content">
        <h3 id="confirmTitle" style="color: var(--text);"></h3>
        <p id="confirmMessage" style="color: var(--light-text); font-size: 0.95rem; margin-bottom: 20px;"></p>
        <div class="modal-buttons">
            <button style="background: #e2e8f0; color: #1e293b; box-shadow: none;" onclick="playTap(); closeConfirmModal(false)">Cancelar</button>
            <button id="confirmActionBtn" onclick="playTap(); closeConfirmModal(true)">Confirmar</button>
        </div>
    </div>
</div>

<div id="pwdModal" class="modal">
    <div class="modal-content">
        <h3 style="margin-top:0;">üõ°Ô∏è Acceso Admin</h3>
        <p style="font-size: 0.85rem; color: var(--light-text);">Introduce la clave maestra</p>
        <input type="password" id="pwdInput" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
        <button onclick="playTap(); checkPassword()">Validar</button>
        <button style="background: transparent; color: var(--light-text); box-shadow: none;" onclick="playTap(); closePasswordModal()">Volver</button>
    </div>
</div>

<div id="toast"></div>

<script>
    // --- L√ìGICA DE AUDIO (TAP) ---
    const tapAudio = new Audio("https://github.com/ManuelVS8/Efectos_audio/blob/37b3eb2da9c15c04dfb71dfe1be60f088ea3cdfc/Tap.mp3?raw=true");
    function playTap() {
        tapAudio.currentTime = 0;
        tapAudio.play().catch(() => {});
    }

    // --- VARIABLES DE ESTADO Y CONFIGURACI√ìN ---
    const ADMIN_PASS = "bejherro";
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyc0KH3TgBhtkDVF2MZ6c7JKMyM3bsb8POxMm7Up0CaA1FtxV5pnfSZ4jQQGsT8T2bYxQ/exec";
    
    let isAdmin = false;
    let appData = { 
        players: [], 
        matches: [], 
        started: false, 
        currentRound: 0, 
        totalRondas: 0 
    };
    let pendingAction = null;

    document.addEventListener('DOMContentLoaded', () => {
        fetchFromGoogle();
        document.getElementById('pwdInput').addEventListener('keypress', e => { 
            if (e.key === 'Enter') checkPassword(); 
        });
    });

    // --- COMUNICACI√ìN CON EL SERVIDOR (APPS SCRIPT) ---
    async function fetchFromGoogle() {
        showLoading("Consultando Nube...");
        try {
            const res = await fetch(`${SCRIPT_URL}?action=read&t=${Date.now()}`);
            if (!res.ok) throw new Error("Error en respuesta");
            const data = await res.json();
            if (data.db) {
                appData = data.db;
                // Si el torneo est√° iniciado pero no hay ronda seleccionada, ir a la √∫ltima
                if (appData.started && appData.currentRound === 0) {
                    const rounds = [...new Set(appData.matches.map(m => m.round))];
                    if (rounds.length > 0) appData.currentRound = Math.max(...rounds);
                }
            }
            renderUI();
        } catch (e) { 
            showToast("‚ùå Sin conexi√≥n o error de servidor"); 
            console.error(e); 
        } finally { 
            hideLoading(); 
        }
    }

    async function sendGoogleAction(action, params = {}) {
        showLoading("Actualizando...");
        try {
            const res = await fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({ action: action, ...params })
            });
            // Como no usamos no-cors, podemos leer la respuesta
            const result = await res.json();
            if (result.status === 'error') {
                showToast("‚ùå " + (result.message || "Error"));
            } else {
                showToast("‚úÖ √âxito");
            }
            setTimeout(fetchFromGoogle, 1000); // Recargar datos
        } catch (e) { 
            showToast("Error de env√≠o"); 
            hideLoading();
        }
    }

    async function syncToGoogle() {
        if (!isAdmin) return;
        showLoading("Guardando Cambios...");
        try {
            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'sync', matches: appData.matches })
            });
            const result = await response.json();
            showToast("‚úÖ Resultados guardados con √©xito");
            setTimeout(fetchFromGoogle, 1000); 
        } catch (e) { 
            showToast("‚ö†Ô∏è Fallo al guardar."); 
            console.error(e);
        } finally { 
            hideLoading(); 
        }
    }

    // --- RENDERIZADO DIN√ÅMICO DE LA INTERFAZ ---
    function renderUI() {
        // Stats
        document.getElementById('statsPlayers').innerText = appData.players.length;
        document.getElementById('statsRounds').innerText = appData.totalRondas || 0;

        // Panel Config
        document.getElementById('playersInput').value = appData.players.length ? appData.players.map(p=>p.name).join('\n') : "";
        document.getElementById('resetCard').style.display = appData.started ? "block" : "none";
        document.getElementById('nextRoundCard').style.display = appData.started ? "block" : "none";
        
        const nextBtn = document.getElementById('nextRoundBtn');
        if (nextBtn) {
            const maxR = appData.matches.length > 0 ? Math.max(...appData.matches.map(m => m.round)) : 0;
            const nextNum = maxR + 1;
            const total = appData.totalRondas || "?";
            
            if (appData.totalRondas > 0 && nextNum > appData.totalRondas) {
                nextBtn.disabled = true;
                nextBtn.innerText = "üèÜ Torneo Finalizado";
            } else {
                nextBtn.disabled = false;
                nextBtn.innerText = `‚è≠Ô∏è Generar Ronda ${nextNum}/${total}`;
            }
        }
        
        if (appData.started) {
            renderRoundSelector();
            renderMatches(appData.currentRound);
            renderRanking();
        } else {
            document.getElementById('roundSelector').innerHTML = "";
            document.getElementById('matchesContainer').innerHTML = `
                <div class="card" style="text-align:center; padding: 40px 20px;">
                    <span style="font-size: 3rem;">‚ôüÔ∏è</span>
                    <h4 style="margin: 15px 0 5px 0; color: var(--light-text);">El torneo a√∫n no ha comenzado</h4>
                    <p style="font-size: 0.8rem; color: var(--light-text);">Ve a la pesta√±a Configuraci√≥n para inscribir jugadores.</p>
                </div>`;
        }
    }

    function renderRoundSelector() {
        const container = document.getElementById('roundSelector');
        container.innerHTML = "";
        const rounds = [...new Set(appData.matches.map(m=>m.round))].sort((a,b)=>a-b);
        if (rounds.length === 0) return;

        rounds.forEach(r => {
            const chip = document.createElement('div');
            chip.className = `round-chip ${r===appData.currentRound ? 'active' : ''}`;
            chip.innerText = `Ronda ${r}`;
            chip.onclick = (e) => { 
                e.stopPropagation(); 
                playTap(); 
                appData.currentRound = r; 
                renderUI(); 
            };
            container.appendChild(chip);
        });
    }

    function renderMatches(r) {
        const container = document.getElementById('matchesContainer');
        container.innerHTML = "";
        const roundMatches = appData.matches.filter(m=>m.round===r);
        
        if(roundMatches.length === 0 && appData.started) {
            container.innerHTML = "<div class='card'>No hay emparejamientos en esta ronda.</div>";
            return;
        }

        roundMatches.forEach((m, idx) => {
            const p1 = appData.players.find(p=>p.id===m.player1Id);
            const p2 = appData.players.find(p=>p.id===m.player2Id);
            const div = document.createElement('div');
            div.className = 'match-card';

            // Calcular balance de color para mostrar
            const bal1 = getColorBalance(p1 ? p1.colorHistory : "");
            const bal2 = getColorBalance(p2 ? p2.colorHistory : "");

            // L√≥gica de BYE (Descanso)
            if (m.player2Id === -1) {
                 div.innerHTML = `
                    <div class="match-header">Mesa ${m.table || idx+1} ‚Ä¢ DESCANSO</div>
                    <div class="players">
                        <div class="player-name">${p1.name} <span class="player-info">${p1.points.toFixed(1)} pts</span></div>
                        <div class="vs">RECIBE</div>
                        <div class="player-name" style="text-align:right">1.0 PT</div>
                    </div>
                    <div style="text-align:center; font-size:0.75rem; color:var(--success); font-weight:700; background: var(--win-color); padding: 5px; border-radius: 5px;">
                        Punto autom√°tico por BYE
                    </div>`;
            } else {
                // Determinar clases de color de resultado
                let cls1 = "", cls2 = "";
                if (m.result === "1-0") { cls1 = "winner"; cls2 = "loser"; }
                else if (m.result === "0-1") { cls1 = "loser"; cls2 = "winner"; }
                else if (m.result === "1/2-1/2") { cls1 = cls2 = "draw"; }

                 div.innerHTML = `
                    <div class="match-header">Mesa ${m.table || idx+1}</div>
                    <div class="players">
                        <div class="player-name ${cls1}">${p1 ? p1.name : 'Desconocido'} <span class="player-info">${p1.points.toFixed(1)} pts (${bal1})</span></div>
                        <div class="vs">vs</div>
                        <div class="player-name ${cls2}" style="text-align:right">${p2 ? p2.name : 'Desconocido'} <span class="player-info">${p2.points.toFixed(1)} pts (${bal2})</span></div>
                    </div>
                    <select class="result-select editable-element" onchange="playTap(); updateMatchLocal('${m.id}', this.value)" onclick="event.stopPropagation()">
                        <option value="" ${!m.result?'selected':''}>‚è≥ Pendiente...</option>
                        <option value="1-0" ${m.result==='1-0'?'selected':''}>Victoria Blancas (1 - 0)</option>
                        <option value="0-1" ${m.result==='0-1'?'selected':''}>Victoria Negras (0 - 1)</option>
                        <option value="1/2-1/2" ${m.result==='1/2-1/2'?'selected':''}>Tablas (¬Ω - ¬Ω)</option>
                    </select>`;
            }
            container.appendChild(div);
        });
    }

    function getColorBalance(history) {
        if(!history) return "0";
        let b=0;
        for(let c of history) { if(c==='B') b++; else if(c==='N') b--; }
        return (b > 0 ? "+" : "") + b;
    }

    function renderRanking() {
        const tbody = document.querySelector('#rankingTable tbody');
        tbody.innerHTML = "";
        const sorted = [...appData.players].sort((a,b) => (b.points - a.points) || (b.buchholz - a.buchholz));
        sorted.forEach((p, i) => {
            tbody.innerHTML += `
                <tr>
                    <td class="rank-col">${i+1}</td>
                    <td style="font-weight:600;">${p.name}</td>
                    <td class="points-col">${p.points}</td>
                    <td style="text-align:right; color: var(--light-text);">${p.buchholz.toFixed(1)}</td>
                </tr>`;
        });
    }

    function updateMatchLocal(id, res) { 
        const m = appData.matches.find(x=>x.id===id); 
        if (m) m.result = res; 
        renderUI();
    }

    // --- CONTROL DE MODALES Y SEGURIDAD ---
    function openConfirmModal(t, m, a) { 
        document.getElementById('confirmTitle').innerText = t; 
        document.getElementById('confirmMessage').innerText = m; 
        pendingAction = a; 
        document.getElementById('confirmModal').style.display = "flex"; 
    }

    function confirmStartTournament() { 
        if(!isAdmin) return; 
        openConfirmModal("üöÄ Iniciar Torneo", "¬øEst√°s seguro? Se borrar√°n datos previos y se generar√° la Ronda 1 con los nombres listados.", "create"); 
    }
    
    function confirmNextRound() {
        if(!isAdmin) return;
        const currentMatches = appData.matches.filter(m => m.round === appData.currentRound);
        const pending = currentMatches.some(m => !m.result && m.player2Id !== -1);
        if (pending) {
            showToast("‚ö†Ô∏è Error: Hay resultados sin anotar en la ronda actual");
            return;
        }
        openConfirmModal("‚è≠Ô∏è Siguiente Ronda", "¬øGenerar nuevos emparejamientos basados en la clasificaci√≥n actual?", "nextRound");
    }

    function confirmResetTournament() { 
        if(!isAdmin) return; 
        openConfirmModal("üõë REINICIO TOTAL", "Esta acci√≥n eliminar√° todos los jugadores y resultados de la base de datos. ¬øProceder?", "reset"); 
    }

    function closeConfirmModal(confirm) { 
        document.getElementById('confirmModal').style.display = "none"; 
        if (confirm) {
            if (pendingAction === 'create') {
                let names = document.getElementById('playersInput').value.split('\n').filter(x => x.trim().length > 0);
                if (names.length < 2) { showToast("Necesitas al menos 2 jugadores"); return; }
                sendGoogleAction('create', { players: names });
            } else if (pendingAction === 'nextRound') {
                sendGoogleAction('nextRound');
            } else if (pendingAction === 'reset') {
                sendGoogleAction('reset');
            }
        }
    }

    // --- ACCESO ADMINISTRADOR ---
    function openPasswordModal(e) { 
        e.stopPropagation(); 
        playTap(); 
        if(isAdmin) { 
            isAdmin = false; 
            updateAdminMode(); 
            showToast("üîí Modo Lectura Activado");
        } else {
            document.getElementById('pwdModal').style.display = "flex"; 
            document.getElementById('pwdInput').focus();
        }
    }

    function closePasswordModal() { document.getElementById('pwdModal').style.display = "none"; }
    
    function checkPassword() { 
        const val = document.getElementById('pwdInput').value;
        if(val === ADMIN_PASS) { 
            isAdmin = true; 
            closePasswordModal(); 
            updateAdminMode(); 
            showToast("üîì Acceso Administrador Concedido"); 
        } else { 
            showToast("‚ùå Contrase√±a incorrecta"); 
        } 
        document.getElementById('pwdInput').value = ""; 
    }

    function updateAdminMode() { 
        const b = document.getElementById('adminBtn'); 
        b.innerHTML = isAdmin ? "üîì" : "üîí"; 
        b.className = isAdmin ? "unlocked" : ""; 
        document.body.className = isAdmin ? "" : "is-locked"; 
    }

    // --- UTILIDADES DE INTERFAZ ---
    function showLoading(t) { 
        document.getElementById('loadingText').innerText = t; 
        document.getElementById('loadingOverlay').style.display = "flex"; 
    }
    
    function hideLoading() { document.getElementById('loadingOverlay').style.display = "none"; }
    
    function showToast(m) { 
        const x = document.getElementById("toast"); 
        x.innerText = m; 
        x.className = "show"; 
        setTimeout(() => { x.className = x.className.replace("show", ""); }, 3000); 
    }

    function switchTab(id, el) { 
        playTap();
        document.querySelectorAll('.tab-content').forEach(x => x.classList.remove('active')); 
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(x => x.classList.remove('active')); 
        el.classList.add('active');
        if(id === 'tab-ranking') renderRanking();
    }

    // --- EXPORTACI√ìN PDF PROFESIONAL ---
    function downloadPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        doc.setFillColor(7, 200, 220);
        doc.rect(0, 0, 210, 30, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(22);
        doc.text("Clasificaci√≥n Final - Torneo Siurot", 15, 20);
        
        doc.setTextColor(30, 41, 59);
        doc.setFontSize(10);
        doc.text(`Fecha de emisi√≥n: ${new Date().toLocaleString()}`, 15, 40);
        
        let y = 55;
        doc.setFontSize(12);
        doc.setFont(undefined, 'bold');
        doc.text("Pos.", 15, y);
        doc.text("Nombre del Jugador", 30, y);
        doc.text("Pts", 160, y);
        doc.text("BH", 185, y);
        
        y += 5;
        doc.setDrawColor(226, 232, 240);
        doc.line(15, y, 195, y);
        
        y += 10;
        doc.setFont(undefined, 'normal');
        const sorted = [...appData.players].sort((a,b) => (b.points - a.points) || (b.buchholz - a.buchholz));
        
        sorted.forEach((p, i) => {
            if(y > 280) { doc.addPage(); y = 20; }
            doc.text(`${i+1}`, 15, y);
            doc.text(`${p.name}`, 30, y);
            doc.text(`${p.points}`, 160, y);
            doc.text(`${p.buchholz.toFixed(1)}`, 185, y);
            y += 9;
        });

        doc.save(`Ranking_Siurot_${Date.now()}.pdf`);
    }
    
    function downloadMatchesPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        doc.setFillColor(15, 23, 42);
        doc.rect(0, 0, 210, 30, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(20);
        doc.text(`Emparejamientos - Ronda ${appData.currentRound}`, 15, 20);
        
        doc.setTextColor(30, 41, 59);
        let y = 45;
        const roundMatches = appData.matches.filter(m => m.round === appData.currentRound);
        
        roundMatches.forEach(m => {
            if(y > 280) { doc.addPage(); y = 20; }
            const p1 = appData.players.find(p=>p.id===m.player1Id);
            const p2 = appData.players.find(p=>p.id===m.player2Id);
            const p1Name = p1 ? p1.name : "?";
            const p2Name = p2 ? p2.name : (m.player2Id === -1 ? "--- DESCANSO ---" : "?");
            
            doc.setFont(undefined, 'bold');
            doc.text(`Mesa ${m.table || '?'}:`, 15, y);
            doc.setFont(undefined, 'normal');
            doc.text(`${p1Name} vs ${p2Name}`, 40, y);
            y += 12;
        });

        doc.save(`Ronda_${appData.currentRound}_Emparejamientos.pdf`);
    }

    // --- REGISTRO PWA (SERVICE WORKER) ---
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then(reg => console.log('‚úÖ Service Worker activo para Ajedrez Siurot'))
          .catch(err => console.error('‚ùå Error al registrar el Service Worker', err));
      });
    }
</script>
</body>
</html>